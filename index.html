<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>사고도구어 타자 연습 — 문장버전</title>
  <!-- FIX: Removed any escaped closing tags like <\/h1>; now using valid </h1> in template strings -->
 
  <style>
    /* Local fonts placed in the same folder as this HTML */
    @font-face {
      font-family: 'ONE Mobile POP';
      src: url('./ONE Mobile POP.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    /* Hakgyoansim Badasseugi – Light(400) */
    @font-face {
      font-family: 'Hakgyoansim Badasseugi';
      src: url('./Hakgyoansim Badasseugi TTF L.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    /* Hakgyoansim Badasseugi – Bold(700) */
    @font-face {
      font-family: 'Hakgyoansim Badasseugi';
      src: url('./Hakgyoansim Badasseugi TTF B.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    /* Fallback */
    @font-face {
      font-family: 'BMJUA';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.0/BMJUA.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
  </style>
  <style>
    :root{
      /* Bright, kid-friendly palette */
      --bg1: #fdf6ff;  /* pale pink */
      --bg2: #e6f7ff;  /* pale sky */
      --panel: #ffffff;
      --border: #C9C9C9;
      --ink: #1f2a44;   /* main text */
      --muted: #8c93a8; /* softer gray-blue */
      --chip: #f4f7ff;
      --primary: #ff7b7b;   /* coral */
      --secondary: #6bd3ff; /* sky */
      --success: #2fb579;   /* green */
      --danger: #ff5a5a;    /* red */
      --warning: #ffb84d;   /* orange */
      --magenta: #ff78c6;   /* magenta */
      --violet: #9f87ff;    /* violet */
      --shadow: 0 18px 40px rgba(18, 28, 49, 0.18);
      --inner: 0 1px 0 rgba(255,255,255,.8) inset, 0 -1px 0 rgba(0,0,0,.04) inset;
    }

    *{box-sizing:border-box}
    html,body{height:100%; overflow-y:auto; overflow-x:hidden;}
    /* 부드럽게 움직이는 파스텔 배경 */
    @keyframes gradientShift{
      0%{background-position:0 0, 100% 0, 0% 50%}
      50%{background-position:-60px -30px, 110% -40px, 100% 50%}
      100%{background-position:0 0, 100% 0, 0% 50%}
    }
    body{
      margin:0; color:var(--ink);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      background:
      radial-gradient(80vmax 50vmax at 20% -10%, rgba(255,232,243,0.9) 0%, rgba(255,232,243,0) 65%),
      radial-gradient(70vmax 50vmax at 100% 0%, rgba(234,247,255,0.9) 0%, rgba(234,247,255,0) 65%),
      linear-gradient(45deg, #FFEFF5, #FFF8E4, #F3FAFF, #F0ECFF, #F7FFE9);
      background-size: 120% 120%, 120% 120%, 400% 400%;
      background-position: 0 0, 100% 0, 0% 50%;
      background-repeat: no-repeat, no-repeat, no-repeat;
      animation: gradientShift 12s ease-in-out infinite;
      font-family: 'Hakgyoansim Badasseugi', 'BMJUA', 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      letter-spacing: .2px; font-size: 20px;
    }

    .container{max-width:1200px; margin:0 auto; padding:16px 24px; min-height:100vh; display:flex; flex-direction:column; gap:12px}

    .title{ font-family: 'ONE Mobile POP', 'BMJUA', 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; text-align:center; line-height:1.05; margin: 2px 0 0; font-size: clamp(40px, 6.5vw, 76px); background: linear-gradient(90deg, #ff7b7b, #ffb84d, #6bd3ff, #9f87ff); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .subtitle{ text-align:center; font-size: 24px; color: var(--muted); margin: 2px 0 6px; font-weight:700; font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; }

    /* 카드 타이틀/온독지수 스타일(선택 화면) */
    .card-title{ font-size:22px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.25; text-align:center; font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .card-ondok{ font-size:16px; color:#6a4cff; font-weight:800; letter-spacing:.2px; }
    .book-card{ background: var(--panel); border: 2px solid var(--border); border-radius: 18px; box-shadow: var(--shadow); padding: 12px; display:flex; flex-direction:column; gap:8px; cursor:pointer; transition: transform .18s ease, box-shadow .18s ease, filter .18s ease; align-items:center; text-align:center; }
    .book-card:hover{ background:#F8F7FF; transform: translateY(-8px); box-shadow: 0 18px 50px rgba(18,28,49,.28); }
    .book-card.selected{ background:#F7E8FF; border-color:#C9C9C9; box-shadow: 0 20px 52px rgba(143,120,255,.22); }
    .start-wrap{ display:flex; justify-content:center; margin: 24px 0 8px; }
    .start-big{ min-width: 320px; height: 76px; font-size: 28px; border-radius: 18px; border:2px solid var(--border); box-shadow: var(--shadow); background:#ECE8FF; color: var(--ink); transition: transform .12s ease, filter .12s ease, box-shadow .12s ease; font-family: 'ONE Mobile POP','BMJUA','Noto Sans KR',sans-serif; font-weight:400; }
    .start-big:disabled{ opacity:.65; cursor:not-allowed; }
    .start-big.on{ background:#ECE8FF; color: var(--ink); cursor:pointer; box-shadow: 0 16px 40px rgba(143,120,255,.35), 0 0 0 2px rgba(143,120,255,.25) inset; }
    .start-big.on:hover{ transform: translateY(-2px); filter: brightness(1.05); }

    /* --- GAME LAYOUT --- */
    .panel{ background: var(--panel); border:2px solid var(--border); border-radius: 22px; box-shadow: var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px; flex:1; min-height:0 }

    /* Header row: cover | book info(+ondok) | fixed stats */
    .head-grid{ display:grid; grid-template-columns: 160px minmax(280px, 1fr) 380px; gap:16px; align-items:center; }
    .cover{ width:160px; height:200px; object-fit:cover; border:2px solid var(--border); border-radius: 16px; box-shadow: var(--inner); }

    .book-meta{ display:flex; flex-direction:column; gap:8px; }
    .book-title{ font-size: 30px; line-height:1.2; font-weight:700; }
    .book-author{ font-size: 20px; color: var(--muted); }
    .ondok-line{ font-size: 26px; margin-top: 2px; }
    .ondok-line strong{ font-size: 34px; color: var(--ink); }

    .stats-fixed{ display:grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: 1fr; gap:12px; }
    .chip{ background: var(--chip); border:2px solid var(--border); border-radius: 14px; padding: 14px; text-align:center; display:flex; flex-direction:column; justify-content:center; box-shadow: var(--inner); }
    .chip .lbl{ display:block; font-size:18px; color:var(--muted); margin-bottom:6px; font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .chip .val{ font-size: 28px; color: var(--success); font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }

    /* Target + input */
    .target{ background: #fff; border: 2px solid var(--border); border-radius: 16px; padding: 16px; min-height: 110px; line-height: 2.1; font-size: 26px; color: var(--ink); box-shadow: var(--inner); }
    .target .ok{ color: var(--success); font-weight: 700; }
    /* 더 차분한 표시: 얇은 밑줄만 */
    .target .err{ color: #c73939; text-decoration: underline; text-decoration-thickness: 2px; text-underline-offset: 4px; font-weight: 700; }
    /* 아직 남은 글자: 진한 검정, 굵게 */
    .target .next{ color: var(--ink); font-weight: 900; text-decoration: none; }

    .row{ display:flex; gap:12px; align-items:center; }
    #typing{ flex:1; font-family: inherit; font-size:26px; padding:16px; border-radius: 16px; border: 2px solid var(--border); outline:none; background:#FFF8F7; color:var(--ink); box-shadow: var(--inner); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; user-select:none; padding: 14px 18px; border-radius: 14px; border:2px solid var(--border); text-decoration:none; font-size: 20px; box-shadow: var(--shadow); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease; font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn.success{ background:#DBEEFF; color: var(--ink); }
    .btn.danger{ background:#FFDBDB; color: var(--ink); }
    .btn.primary{ background: linear-gradient(180deg, var(--primary), #ff9866); color:#fff; }
    .btn.secondary{ background: linear-gradient(180deg, var(--secondary), #49b6ff); color:#fff; }
    .btn.pink{ background: linear-gradient(180deg, var(--magenta), #ff9fde); color:#fff; }
    .btn.neutral{ background: linear-gradient(180deg, #eef3fb, #d6e0f3); color: var(--ink); }

    .nextbox{ background:#fff; border:2px solid var(--border); border-radius:12px; padding:12px; box-shadow: var(--inner); }
    .nextbox .lbl{ font-size:18px; color:var(--muted); margin-bottom:6px; display:block; }
    .nextbox .sent{ font-size:20px; color: var(--muted); font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:400; }

    /* Keep whole app within viewport (no scroll) */
    .flex-spacer{ flex:1; min-height:0 }

    /* Overlays */
    .overlay{ position:fixed; inset:0; background: rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index: 10; }
    .overlay.show{ display:flex; }
    .pause-box{ background: #fff; border:2px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 24px; text-align:center; width:min(520px, 92vw); font-size:18px; }

    /* Result Modal – refined glass look */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0, 6, 20, 0.35); backdrop-filter: blur(4px); z-index:20; }
    .modal.show{ display:flex; }
    .modal-card{ background:#E8F8FF; border:2px solid var(--border); border-radius:18px; box-shadow: 0 18px 50px rgba(24,36,56,.28); width:min(640px, 94vw); padding: 24px; }
    .modal-title{ font-size:34px; margin: 2px 0 10px; color: var(--success); text-align:center; letter-spacing: .5px; font-weight:800; }
    .modal-msg{ text-align:center; font-size:20px; color:#4b5563; margin-bottom: 14px; font-weight:700; }
    .modal-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:14px; margin-bottom: 16px; }
    .modal-grid .chip{ background: var(--chip); }
    .modal-grid .chip .val{ color: var(--warning); font-size:26px; font-family: 'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .modal-actions{ display:flex; gap:12px; justify-content:center; }
    .help{ font-size:16px; color: var(--muted); margin-top: 10px; text-align:center; }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Pause Overlay -->
  <div id="pauseOverlay" class="overlay" aria-hidden="true">
    <div class="pause-box">
      <div style="font-size:22px; color:var(--ink); margin-bottom:8px">일시 정지</div>
      <div class="help">계속하려면 아래 버튼을 누르거나 Esc 키를 누르세요.</div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:12px">
        <button class="btn secondary" id="resumeBtn">계속하기</button>
        <button class="btn primary" id="toSelectBtn">처음으로</button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div id="resultModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-title">완료!</div>
      <div id="mMsg" class="modal-msg">잘했어요! 계속 가볼까요? 👍</div>
      <div class="modal-grid">
        <div class="chip"><span class="lbl">소요시간(초)</span><span id="mTime" class="val">0</span></div>
        <div class="chip"><span class="lbl">입력글자(타수)</span><span id="mChars" class="val">0</span></div>
        <div class="chip"><span class="lbl">정확도(%)</span><span id="mAcc" class="val">0</span></div>
        <div class="chip"><span class="lbl">타자 속도(타/분)</span><span id="mSpeed" class="val">0</span></div>
      </div>
      <div class="help">Enter: 계속하기  ·  ESC: 다시하기</div>
      <div class="modal-actions">
        <button class="btn success" id="keepBtn">계속하기 (Enter)</button>
        <button class="btn danger" id="redoBtn">다시하기 (ESC)</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    // ---------- Utilities ----------
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
    function setText(sel, text){ var el = $(sel); if(el){ el.textContent = String(text); } }
    function addClass(sel, cls){ var el = $(sel); if(el){ el.classList.add(cls); el.setAttribute('aria-hidden','false'); } }
    function removeClass(sel, cls){ var el = $(sel); if(el){ el.classList.remove(cls); el.setAttribute('aria-hidden','true'); } }
    function escapeHTML(str){ return String(str).replace(/[&<>"']/g, function(s){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[s] }); }

    // ---------- Alignment helpers ----------
    function alignOps(target, typed){
      var n = target.length, m = typed.length;
      var dp = new Array(n+1);
      for(var i=0;i<=n;i++){ dp[i] = new Array(m+1); }
      for(i=0;i<=n;i++){ dp[i][0] = i; }
      for(var j=0;j<=m;j++){ dp[0][j] = j; }
      for(i=1;i<=n;i++){
        for(j=1;j<=m;j++){
          var cost = (target.charAt(i-1) === typed.charAt(j-1)) ? 0 : 1;
          var a = dp[i-1][j] + 1;      // deletion
          var b = dp[i][j-1] + 1;      // insertion
          var c = dp[i-1][j-1] + cost; // match/substitute
          dp[i][j] = Math.min(a,b,c);
        }
      }
      var ops = []; i=n; j=m;
      while(i>0 || j>0){
        if(i>0 && j>0){
          var costDiag = (target.charAt(i-1) === typed.charAt(j-1)) ? 0 : 1;
          if(dp[i][j] === dp[i-1][j-1] + costDiag){ ops.push({op:'diag', match: costDiag===0, ch: target.charAt(i-1)}); i--; j--; continue; }
        }
        if(i>0 && dp[i][j] === dp[i-1][j] + 1){ ops.push({op:'del', ch: target.charAt(i-1)}); i--; continue; }
        if(j>0 && dp[i][j] === dp[i][j-1] + 1){ ops.push({op:'ins', ch: typed.charAt(j-1)}); j--; continue; }
        if(i>0){ ops.push({op:'del', ch: target.charAt(i-1)}); i--; } else { ops.push({op:'ins', ch: typed.charAt(j-1)}); j--; }
      }
      ops.reverse();
      return ops;
    }

    function diffMarkup(target, typed){
      var ops = alignOps(target, typed||'');
      var out = '';
      for(var k=0;k<ops.length;k++){
        var o = ops[k];
        if(o.op === 'diag'){
          out += '<span class="' + (o.match ? 'ok' : 'err') + '">' + escapeHTML(o.ch) + '</span>';
        } else if(o.op === 'del'){
          out += '<span class="next">' + escapeHTML(o.ch) + '</span>'; // calm next text
        } else if(o.op === 'ins'){
          continue; // do not render extra typed char to reduce noise
        }
      }
      return out;
    }

    function calcCpm(charCount, seconds){ var secs = Math.max(0, seconds||0); var mins = secs / 60; return mins > 0 ? Math.round(charCount / mins) : 0; }

    function calcAccuracy(target, typed){
      // 이전 버전은 '입력된 글자 수(consumed)'만 분모로 사용해
      // 삭제(del), 즉 '빠뜨린 공백'이 정확도에 반영되지 않았습니다.
      // 이제는 삽입(ins)·삭제(del)·치환(diag mismatch) 모두를 오류로 계산합니다.
      typed = typed || '';
      if(target.length === 0 && typed.length === 0) return 100;
      var ops = alignOps(target, typed);
      var match = 0, errors = 0;
      for(var k=0;k<ops.length;k++){
        var o = ops[k];
        if(o.op === 'diag'){
          if(o.match) match++; else errors++; // 치환(불일치)도 오류
        } else if(o.op === 'del' || o.op === 'ins'){
          errors++; // 빠뜨린 공백(del)과 불필요한 입력(ins) 모두 오류
        }
      }
      var total = match + errors;
      if(total === 0) return 0;
      return Math.max(0, Math.min(100, Math.round((match/total)*100)));
    }

    function feedback(acc, speed){
      if(acc === 100 && speed >= 200) return '브라보! 정말 잘하고 있어요! ✨';
      if(acc >= 95) return '완벽에 가까워요! 👍';
      if(acc >= 85) return '좋아요! 집중력을 유지해요! 💪';
      return '천천히, 하지만 정확하게! 😊';
    }

    // ---------- Data ----------
    var BOOKS = [
      { id: 'hedgehog', title: '미움을 파는 고슴도치', author: '슬라비 스토에프', ondok: 238, cover: 'https://image.yes24.com/goods/103073730/XL',
        sentences: [ '고슴도치는 미움을 팔았지만 누구도 행복하지 못했어요.', '진심 어린 말 한마디가 마음의 가시에 약이 되었지요.' ] },
      { id: 'complain', title: '불만왕 뽑기대회', author: '정복현·이갑규', ondok: 294, cover: 'https://image.yes24.com/goods/99307997/XL',
        sentences: [ '마을 사람들은 사소한 불만을 모아 왕을 뽑기로 했어요.', '불평 대신 해결책을 말하니 모두의 얼굴이 환해졌어요.' ] },
      { id: 'fake', title: '가짜 뉴스를 시작하겠습니다', author: '김경옥', ondok: 269, cover: 'https://image.yes24.com/goods/82892578/XL',
        sentences: [ '화려한 제목 뒤에는 근거 없는 말들이 숨어 있었어요.', '사실을 확인하자 기사 한 줄의 의미가 달라졌어요.' ] },
      { id: 'monster', title: '몬스터 차일드', author: '이재문', ondok: 333, cover: 'https://image.yes24.com/goods/103668412/XL',
        sentences: [ '아이의 마음속 괴물은 외로움에서 자랐어요.', '친구가 손을 내밀자 괴물은 작아지기 시작했어요.' ] }
    ];

    // ---------- State ----------
    var state = { screen: 'select', currentBook: null, sentenceIndex: 0, target: '', startedAt: 0, timerId: null, seconds: 0, isPaused: false, finished: false };
    var app = $('#app');

    // ---------- UI ----------
    function renderSelect(){
      state.screen = 'select';
      clearTimer();
      app.innerHTML = `
        <div class="container">
          <h1 class="title">사고도구어 타자연습 -문장버전-</h1>
          <div class="subtitle">원하는 책을 고르고 시작하세요!</div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap:16px;">
            ${BOOKS.map(b => `
              <div class="book-card" data-id="${b.id}">
                <img class="cover" src="${b.cover}" alt="${b.title} 표지"/>
                <div class="card-title">${b.title}</div>
                <div style="font-size:16px; color: var(--muted);">${b.author}</div>
                <div class="card-ondok">온독지수 ${b.ondok}</div>
              </div>
            `).join('')}
          </div>
          <div class="start-wrap"><button class="start-big" id="startBig" disabled>시작하기</button></div>
        </div>`;

      var selectedId = null;
      var cards = $all('.book-card');
      var startBig = $('#startBig');
      cards.forEach(function(card){
        card.addEventListener('click', function(){
          cards.forEach(function(c){ c.classList.remove('selected'); });
          card.classList.add('selected');
          selectedId = card.getAttribute('data-id');
          if(startBig){ startBig.disabled = false; startBig.classList.add('on'); }
        });
      });
      if(startBig){
        startBig.addEventListener('click', function(){
          if(!selectedId) return;
          var book = BOOKS.find(function(x){ return x.id === selectedId; });
          if(book){ startGame(book); }
        });
      }}

    function startGame(book){ state.currentBook = book; state.sentenceIndex = 0; prepareSentence(); renderGame(); focusInputSoon(); }

    function prepareSentence(){
      var list = state.currentBook.sentences; var idx = state.sentenceIndex % list.length;
      state.target = list[idx]; state.seconds = 0; state.startedAt = 0; state.isPaused = false; state.finished = false; clearTimer();
    }

    function getNextSentence(){ var list = state.currentBook.sentences; var nextIdx = (state.sentenceIndex + 1) % list.length; return list[nextIdx]; }

    function renderGame(){
      state.screen = 'game'; var b = state.currentBook;
      app.innerHTML = (
        '<div class="container">\n' +
          '<h1 class="title">사고도구어 한컴타자 · 문장</h1>\n' +
          '<section class="panel">\n' +
            '<div class="head-grid">\n' +
              '<img class="cover" src="' + b.cover + '" alt="표지"/>\n' +
              '<div class="book-meta">\n' +
                '<div class="book-title">' + b.title + '</div>\n' +
                '<div class="book-author">' + b.author + '</div>\n' +
                '<div class="ondok-line">온독지수 <strong>' + b.ondok + '</strong></div>\n' +
              '</div>\n' +
              '<div class="stats-fixed">\n' +
                '<div class="chip"><span class="lbl">시간(초)</span><span id="s-time" class="val">0</span></div>\n' +
                '<div class="chip"><span class="lbl">글자 수</span><span id="s-chars" class="val">0</span></div>\n' +
                '<div class="chip"><span class="lbl">정확도(%)</span><span id="s-acc" class="val">0</span></div>\n' +
                '<div class="chip"><span class="lbl">타자속도(타/분)</span><span id="s-speed" class="val">0</span></div>\n' +
              '</div>\n' +
            '</div>\n' +

            '<div id="target" class="target" style="margin-top:6px"></div>\n' +

            '<div class="row">\n' +
              '<input id="typing" type="text" inputmode="text" autocomplete="off" spellcheck="false" placeholder="여기에 입력… (엔터: 결과)" />\n' +
              '<button class="btn secondary" id="pauseBtn" title="일시 정지(P)">⏸ 일시정지</button>\n' +
            '</div>\n' +

            '<div class="nextbox">\n' +
              '<span class="lbl">다음 문장 미리보기</span>\n' +
              '<div id="nextSentence" class="sent"></div>\n' +
            '</div>\n' +

            '<div class="row" style="justify-content:flex-end">\n' +
              '<button class="btn neutral" id="restartBook">다시하기</button>\n' +
              '<button class="btn pink" id="backBtn">처음으로</button>\n' +
            '</div>\n' +
          '</section>\n' +
        '</div>'
      );

      updateTargetHighlight('');
      setText('#nextSentence', getNextSentence());

      var typing = $('#typing'); if(typing){ typing.addEventListener('input', onType); typing.addEventListener('keydown', onKey); }
      var pauseBtn = $('#pauseBtn'); if(pauseBtn){ pauseBtn.addEventListener('click', togglePause); }
      var restartBook = $('#restartBook'); if(restartBook){ restartBook.addEventListener('click', restartCurrent); }
      var backBtn = $('#backBtn'); if(backBtn){ backBtn.addEventListener('click', renderSelect); }

      // Pause/Modal buttons
      var resumeBtn = $('#resumeBtn'); if(resumeBtn){ resumeBtn.onclick = function(){ if(state.isPaused){ togglePause(); } }; }
      var toSelectBtn = $('#toSelectBtn'); if(toSelectBtn){ toSelectBtn.onclick = function(){ hidePause(); renderSelect(); }; }
      var keepBtn = $('#keepBtn'); if(keepBtn){ keepBtn.onclick = function(){ hideModal(); nextSentence(); }; }
      var redoBtn = $('#redoBtn'); if(redoBtn){ redoBtn.onclick = function(){ hideModal(); restartCurrent(); }; }

      state.startedAt = 0; state.seconds = 0; state.finished = false; clearTimer();
      focusInputSoon();
      renderStats('');

      window.onkeydown = function(ev){
        // When modal open: Enter=continue, ESC=redo
        if($('#resultModal').classList.contains('show')){
          if(ev.key === 'Enter'){ ev.preventDefault(); hideModal(); nextSentence(); return; }
          if(ev.key === 'Escape'){ ev.preventDefault(); hideModal(); restartCurrent(); return; }
        }
        if(state.screen !== 'game') return;
        if(String(ev.key).toLowerCase() === 'p'){ ev.preventDefault(); togglePause(); }
        if(ev.key === 'Escape'){ ev.preventDefault(); renderSelect(); }
      };
    }

    function focusInputSoon(){ setTimeout(function(){ var t = $('#typing'); if(t){ t.focus(); } }, 50); }

    // ---------- Typing & Stats ----------
    function onType(e){ if(state.isPaused || state.finished) { e.preventDefault(); return; }
      var val = e.target.value; if(!state.startedAt){ state.startedAt = Date.now(); startTimer(); }
      updateTargetHighlight(val); renderStats(val); }

    function onKey(e){
      if(e.key === 'Enter'){
        // 버블링되어 즉시 다음 문장으로 넘어가던 문제 방지
        e.preventDefault();
        e.stopPropagation();
        submitRound();
      }
    }

    function submitRound(){ if(state.finished) return; finishRound(); }

    function updateTargetHighlight(typed){ var t = state.target; var targetEl = $('#target'); if(targetEl){ targetEl.innerHTML = diffMarkup(t, typed || ''); } }

    function renderStats(typedVal){ var val = typedVal || ''; var secs = Math.max(0, state.seconds); var speed = calcCpm(val.length, secs); var acc = calcAccuracy(state.target, val); setText('#s-time', secs); setText('#s-chars', val.length); setText('#s-acc', acc); setText('#s-speed', speed); }

    function startTimer(){ clearTimer(); state.timerId = setInterval(function(){ if(!state.isPaused && !state.finished){ var now = Date.now(); state.seconds = Math.floor((now - state.startedAt)/1000); var inputEl = $('#typing'); var val = inputEl ? inputEl.value : ''; renderStats(val); } }, 200); }
    function clearTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId = null; } }

    function finishRound(){
      var inputEl = $('#typing');
      var val = inputEl ? inputEl.value : '';
      var typedLen = val.length;
      var secsNow = state.startedAt ? Math.max(1, Math.floor((Date.now() - state.startedAt)/1000)) : Math.max(1, state.seconds);
      var speedNow = calcCpm(typedLen, secsNow);
      var accNow = calcAccuracy(state.target, val);
      clearTimer(); state.finished = true; if(inputEl){ inputEl.disabled = true; }
      setText('#mTime', secsNow); setText('#mChars', typedLen); setText('#mSpeed', speedNow); setText('#mAcc', accNow);
      setText('#mMsg', feedback(accNow, speedNow));
      showModal();
    }

    function restartCurrent(){
      clearTimer(); state.finished = false; state.seconds = 0; state.startedAt = 0; state.isPaused = false; // same sentenceIndex
      var inputEl = $('#typing'); if(inputEl){ inputEl.disabled = false; inputEl.value=''; }
      updateTargetHighlight(''); renderStats(''); focusInputSoon();
    }

    function nextSentence(){ state.sentenceIndex++; prepareSentence(); renderGame(); focusInputSoon(); }

    // ---------- Pause & Modal ----------
    function togglePause(){ if(state.finished) return; if(state.isPaused){ state.isPaused = false; hidePause(); state.startedAt = Date.now() - state.seconds*1000; startTimer(); var t = $('#typing'); if(t){ t.focus(); } } else { state.isPaused = true; showPause(); clearTimer(); } }
    function showPause(){ addClass('#pauseOverlay', 'show'); }
    function hidePause(){ removeClass('#pauseOverlay', 'show'); }
    function showModal(){ addClass('#resultModal', 'show'); }
    function hideModal(){ removeClass('#resultModal', 'show'); }

    // ---------- Self Tests ----------
    function assert(cond, msg){ if(!cond){ throw new Error('❌ ' + msg); } else { return '✅ ' + msg; } }
    function runSelfTests(){
      var results = [];
      results.push(assert(!!$('#app'), '#app 존재'));
      results.push(assert(!!$('#pauseOverlay'), 'pauseOverlay 존재'));
      results.push(assert(!!('#resultModal'), 'resultModal 선택자 OK'));
      results.push(assert(calcCpm(120, 60) === 120, 'CPM 120/60=120'));
      results.push(assert(calcAccuracy('ABC', 'ABC') === 100, '정확도 100%'));
      results.push(assert(calcAccuracy('ABC', 'AXC') === 67 || calcAccuracy('ABC', 'AXC') === 66, '정확도 대략 66~67%'));
      // 공백 누락 시 정확도가 100%가 되지 않아야 함
      var accSpace = calcAccuracy('A B', 'AB');
      results.push(assert(accSpace === 66 || accSpace === 67, '띄어쓰기 누락 → 정확도 < 100% (≈66~67%)'));
      var dm = diffMarkup('AB CD', 'ABX CD'); results.push(assert(dm.indexOf('class=\"err\"') > -1 && dm.indexOf('class=\"ok\"') > -1, 'diffMarkup 정렬 후 표시'));
      var dm2 = diffMarkup('AB CD', 'ABCD'); var errCount = (dm2.match(/class=\"err\"/g)||[]).length; results.push(assert(errCount <= 2, '공백 탈자 시 전체 붉게 보이지 않음'));
      alert('자체 테스트 결과:\n' + results.join('\n'));
    }

    // boot
    window.addEventListener('DOMContentLoaded', function(){ renderSelect(); });
  </script>
</body>
</html>

